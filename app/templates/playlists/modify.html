{% extends "layout.html" %}
{% block content %}
<div class="row center-align">
	<div class="col s12 m6">
		<h6 class="grey-text text-lighten-1">Spotify Playlist</h6>
		<h5>{{ playlist.spotify_playlist_data.name }}</h5>
	</div>
	<div class="col s12 m6">
		<h6 class="grey-text text-lighten-1">Google Play Music Playlist</h6>
		<h5>{{ playlist.google_playlist_data.name }}</h5>
	</div>
</div>

<div class="row">
	<div class="col s12 center-align">
		<h6 class="grey-text text-lighten-1">Playlist Master</h6>
		<strong>{{ playlist.master }}</strong>
	</div>
</div>

<div class="row">
	<div class="col s12 right-align">
		<a class="btn-flat left" href="/playlists/{{ playlist._id }}">Cancel</a>

		<!-- Dropdown Trigger -->
		<a class='dropdown-button btn deep-orange lighten-2' href='#' data-activates='playlist-action' data-beloworigin='true' ><i class="material-icons left">toc</i> Playlist Actions</a>

		<!-- Dropdown Structure -->
		<ul id='playlist-action' class='dropdown-content'>
			<li><a href="/preload/playlists/{{ playlist._id }}/publish">Publish Playlists</a></li>
			<li><a href="/preload/playlists/{{ playlist._id }}/autofill">Autofill Missing Tracks</a></li>
			<li class="divider"></li>
			<li><a href="/preload/playlists/{{ playlist._id }}/reset" class="orange-text">Reset Track Data</a></li>
			<li><a href="/playlists/{{ playlist._id }}/delete" class="red-text">Delete</a></li>
		</ul>
	</div>
</div>

{% if playlist.tracks %}
{% for track in playlist.tracks %}

<div class="row">
	<div class="col s12">
		<h6 class="grey-text">Track #{{ loop.index }}</h6>
		<h5>{{ track.title }}</h5>
		<h6 class="right">{{ track.artists[0].name }}</h6>
	</div>
</div>

<div class="row">
	<div class="col s12">
		<ul class="collapsible" data-collapsible="expandable">
			<li>
				<div class="collapsible-header active">
					<strong>Spotify Track Information</strong>
				</div>
				<div class="collapsible-body">
					{% if track.spotify_data %}

					{{ service_track_data('Spotify', track._id, track.spotify_data) }}

					{% else %}
					<div class="row">
						<div class="col s12">
							<p class="grey-text"><em>No Spotify Track data yet...</em></p>
						</div>
					</div>
					{% endif %}
				</div>
			</li>
			<li>
				<div class="collapsible-header active">
					<strong>Google Play Music Track Information</strong>
				</div>
				<div class="collapsible-body">
					{% if track.google_data %}

					{{ service_track_data('Google Play Music', track._id, track.google_data) }}

					{% else %}
					<div class="row">
						<div class="col s12">
							<p class="grey-text"><em>No Google Play Music Track data yet...</em></p>
						</div>
					</div>
					{% endif %}
				</div>
			</li>
		</ul>
	</div>
</div>
{% endfor %}
{% endif %}

<script type="text/javascript">
var playlist_id = "{{ playlist._id }}";
$(document).ready(function() {
	$(".similar-tracks-toggle").click(function() {
		$(this).parent().parent().find(".collection").slideToggle();
	})

	$(".substitute-track").click(function() {
		// Playlist track ID to modify
		track_id = $(this).attr("data-track-id");

		var payload = {};

		if($(this).attr("data-google-id") != "None") {
			payload.google_id = $(this).attr("data-google-id");
		}

		if($(this).attr("data-spotify-id") != "None") {
			payload.spotify_id = $(this).attr("data-spotify-id");
		}

		$.post("/playlists/" + playlist_id + "/tracks/" + track_id, payload)
			.always(function(data) {
				location.reload();
			}
		);
	})
});
</script>
{% endblock %}

{% macro service_track_data(service_name='', track_id='', track_data={}) -%}
<div class="row service-track">
	<div class="col s3">
		<div class="img-dec">
			<img src="{{ track_data.album.art }}" class="responsive-img album-art" />
		</div>
	</div>
	<div class="col s9">
		<div class="section">
			<span class="grey-text">title</span>
			<div class="seperator"></div>
			<strong>{{ track_data.title }}</strong>
		</div>
		<div class="section">
			<span class="grey-text">artist</span>
			<div class="seperator"></div>
			<strong>{{ track_data.artists[0].name }}</strong>
		</div>
		<div class="section">
			<span class="grey-text">album</span>
			<div class="seperator"></div>
			<strong>{{ track_data.album.name }}</strong>
		</div>
	</div>
</div>
<div class="row">
	<div class="col s12">
		<div class="section padding">
			<h6 class="grey-text"><a href="javascript:void(0)" class="similar-tracks-toggle">similar tracks ({{ track_data.similar_tracks|length }})</a></h6>

			<div class="collection" style="display: none">
			{% if track_data.similar_tracks %}

			{% for similar_track in track_data.similar_tracks %}

				<div class="collection-item avatar">
					<img src="{{ similar_track.album.art }}" class="circle" />
					<span class="title">{{ similar_track.title }}</span>
					<div>
						<span class="grey-text">artist</span> <strong>{{ similar_track.artists[0].name }}</strong>
						<br />
						<span class="grey-text">album</span> <strong>{{ similar_track.album.name }}</strong>
					</div>
					<button href="#" class="btn btn-flat substitute-track right" data-track-id="{{ track_id }}" data-google-id="{{ similar_track.google_id }}" data-spotify-id="{{ similar_track.spotify_id }}">Use this track</button>
					<div style="clear: both"></div>
				</div>

			{% endfor %}

			{% else %}

			<em>No similar tracks found, try your own search</em>

			{% endif %}
			</div>
		</div>
	</div>
</div>
{%- endmacro %}